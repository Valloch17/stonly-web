<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="/assets/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="/assets/favicon-192.png" sizes="192x192" type="image/png">
  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png" sizes="180x180">
  <title>Stonly Builder Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/shared.css">
</head>

<body class="min-h-screen flex items-center justify-center px-4">
  <main class="w-full max-w-md">
    <div class="bg-card border rounded-xl shadow-sm p-6 space-y-4">
      <header class="space-y-1">
        <div class="flex items-center gap-3">
          <img src="/assets/Stonly_logotype_master_digital.svg" alt="Stonly" class="h-8 w-auto logo-light">
          <img src="/assets/Stonly_logotype_full_white_digital.svg" alt="Stonly" class="h-8 w-auto logo-dark">
        </div>
        <h1 class="text-xl font-semibold mt-2">Builder access</h1>
        <p class="text-sm text-slate-500 dark:text-slate-400">
          Log in to your builder account or create one with the admin token.
        </p>
      </header>

      <form id="loginForm" class="space-y-4" onsubmit="return false;">
        <div>
          <label for="loginEmail" class="block text-sm font-medium">Email</label>
          <input id="loginEmail" type="email" autocomplete="email"
                 class="mt-1 w-full border rounded-lg p-2 text-sm"
                 placeholder="email@company.com" />
        </div>
        <div>
          <label for="loginPassword" class="block text-sm font-medium">Password</label>
          <input id="loginPassword" type="password" autocomplete="current-password"
                 class="mt-1 w-full border rounded-lg p-2 text-sm"
                 placeholder="Your password" />
        </div>
        <div class="space-y-2">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <button id="showReset" type="button" class="hover:text-slate-700">Forgot password?</button>
          </div>
          <p id="loginError" class="text-sm text-red-600 min-h-[1.25rem]"></p>
          <p id="loginNotice" class="text-sm text-emerald-600 min-h-[1.25rem] hidden"></p>
          <button id="loginBtn" type="button"
                  class="w-full inline-flex items-center justify-center px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 transition">
            Log in
          </button>
        </div>
        <div class="flex items-center gap-3 text-xs text-slate-400">
          <span class="flex-1 h-px bg-slate-200"></span>
          or
          <span class="flex-1 h-px bg-slate-200"></span>
        </div>
        <button id="googleLogin" type="button"
                class="w-full inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg border border-slate-300 bg-card text-sm font-medium hover:bg-slate-50 transition">
          <svg width="18" height="18" viewBox="0 0 48 48" aria-hidden="true">
            <path fill="#EA4335" d="M24 9.5c3.54 0 6.73 1.22 9.26 3.6l6.9-6.9C35.98 2.52 30.47 0 24 0 14.62 0 6.53 5.38 2.56 13.22l7.98 6.2C12.54 13.5 17.77 9.5 24 9.5z"/>
            <path fill="#4285F4" d="M46.5 24.5c0-1.73-.15-3.39-.43-5H24v9.5h12.6c-.55 2.97-2.22 5.49-4.75 7.2l7.29 5.64c4.27-3.94 6.36-9.75 6.36-17.34z"/>
            <path fill="#FBBC05" d="M10.54 28.92A14.5 14.5 0 0 1 9.5 24c0-1.71.3-3.37.84-4.92l-7.98-6.2A23.98 23.98 0 0 0 0 24c0 3.87.93 7.54 2.56 10.78l7.98-5.86z"/>
            <path fill="#34A853" d="M24 48c6.48 0 11.92-2.13 15.89-5.8l-7.29-5.64c-2.02 1.35-4.6 2.14-8.6 2.14-6.23 0-11.46-4-13.46-9.62l-7.98 5.86C6.53 42.62 14.62 48 24 48z"/>
          </svg>
          Continue with Google
        </button>
        <p class="text-sm text-slate-500">
          Don't have an account yet?
          <button id="showSignup" type="button" class="text-blue-600 hover:text-blue-700 font-medium">Sign up</button>
        </p>
      </form>

      <form id="signupForm" class="space-y-3 hidden" onsubmit="return false;">
        <div>
          <label for="signupEmail" class="block text-sm font-medium">Email</label>
          <input id="signupEmail" type="email" autocomplete="email"
                 class="mt-1 w-full border rounded-lg p-2 text-sm"
                 placeholder="email@company.com" />
        </div>
        <div>
          <label for="signupPassword" class="block text-sm font-medium">Password</label>
          <input id="signupPassword" type="password" autocomplete="new-password"
                 class="mt-1 w-full border rounded-lg p-2 text-sm"
                 placeholder="Minimum 8 characters" />
        </div>
        <div>
          <label for="signupAdminToken" class="block text-sm font-medium">Admin token <span class="text-red-600">*</span></label>
          <input id="signupAdminToken" type="password" autocomplete="off"
                 class="mt-1 w-full border rounded-lg p-2 text-sm"
                 placeholder="Provided by Stonly admin" />
        </div>
        <div class="space-y-2">
          <p id="signupError" class="text-sm text-red-600 min-h-[1.25rem]"></p>
          <button id="signupBtn" type="button"
                  class="w-full inline-flex items-center justify-center px-3 py-2 rounded-lg bg-slate-900 text-white text-sm font-medium hover:bg-slate-800 transition">
            Create account
          </button>
        </div>
        <p class="text-sm text-slate-500">
          Already have an account?
          <button id="showLoginFromSignup" type="button" class="text-blue-600 hover:text-blue-700 font-medium">Log in</button>
        </p>
      </form>

      <form id="resetForm" class="space-y-4 hidden" onsubmit="return false;">
        <div>
          <label for="resetEmail" class="block text-sm font-medium">Email</label>
          <input id="resetEmail" type="email" autocomplete="email"
                 class="mt-1 w-full border rounded-lg p-2 text-sm"
                 placeholder="email@company.com" />
        </div>
        <div>
          <label for="resetAdminToken" class="block text-sm font-medium">Admin token</label>
          <input id="resetAdminToken" type="password" autocomplete="off"
                 class="mt-1 w-full border rounded-lg p-2 text-sm"
                 placeholder="Provided by Stonly admin" />
        </div>
        <div>
          <label for="resetPassword" class="block text-sm font-medium">New password</label>
          <input id="resetPassword" type="password" autocomplete="new-password"
                 class="mt-1 w-full border rounded-lg p-2 text-sm"
                 placeholder="Minimum 8 characters" />
        </div>
        <div>
          <label for="resetPasswordConfirm" class="block text-sm font-medium">Confirm new password</label>
          <input id="resetPasswordConfirm" type="password" autocomplete="new-password"
                 class="mt-1 w-full border rounded-lg p-2 text-sm"
                 placeholder="Re-enter new password" />
        </div>
        <p id="resetError" class="text-sm text-red-600 min-h-[1.25rem]"></p>
        <button id="resetBtn" type="button"
                class="w-full inline-flex items-center justify-center px-3 py-2 rounded-lg bg-slate-900 text-white text-sm font-medium hover:bg-slate-800 transition">
          Reset password
        </button>
        <p class="text-sm text-slate-500">
          Remembered your password?
          <button id="showLoginFromReset" type="button" class="text-blue-600 hover:text-blue-700 font-medium">Back to log in</button>
        </p>
      </form>
    </div>
  </main>

  <script src="/js/shared.js?v=1"></script>
  <script>
    (window.onReady || (fn => fn()))(function () {
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      const resetForm = document.getElementById('resetForm');
      const loginError = document.getElementById('loginError');
      const loginNotice = document.getElementById('loginNotice');
      const signupError = document.getElementById('signupError');
      const resetError = document.getElementById('resetError');
      const loginBtn = document.getElementById('loginBtn');
      const signupBtn = document.getElementById('signupBtn');
      const resetBtn = document.getElementById('resetBtn');
      const showSignup = document.getElementById('showSignup');
      const showLoginFromSignup = document.getElementById('showLoginFromSignup');
      const showReset = document.getElementById('showReset');
      const showLoginFromReset = document.getElementById('showLoginFromReset');
      const googleLogin = document.getElementById('googleLogin');

      function clearMessages() {
        if (loginError) loginError.textContent = '';
        if (signupError) signupError.textContent = '';
        if (resetError) resetError.textContent = '';
        if (loginNotice) {
          loginNotice.textContent = '';
          loginNotice.classList.add('hidden');
        }
      }

      function setView(view) {
        if (loginForm) loginForm.classList.toggle('hidden', view !== 'login');
        if (signupForm) signupForm.classList.toggle('hidden', view !== 'signup');
        if (resetForm) resetForm.classList.toggle('hidden', view !== 'reset');
        clearMessages();
      }

      async function doLogin() {
        const email = (document.getElementById('loginEmail')?.value || '').trim();
        const password = (document.getElementById('loginPassword')?.value || '').trim();
        clearMessages();
        if (!email || !password) {
          if (loginError) loginError.textContent = 'Enter email and password.';
          return;
        }
        const base = ((window.BASE || window.DEFAULT_BACKEND || window.location.origin) || '').replace(/\/+$/, '');
        try {
          const res = await fetch(base + '/api/login', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ email, password }),
            credentials: 'include',
          });
          if (!res.ok) {
            if (loginError) loginError.textContent = 'Invalid email or password.';
            return;
          }
          const params = new URLSearchParams(window.location.search || '');
          const next = params.get('next') || '/';
          window.location.href = next;
        } catch (e) {
          if (loginError) loginError.textContent = 'Login failed. Please retry.';
        }
      }

      async function doSignup() {
        const email = (document.getElementById('signupEmail')?.value || '').trim();
        const password = (document.getElementById('signupPassword')?.value || '').trim();
        const adminToken = (document.getElementById('signupAdminToken')?.value || '').trim();
        clearMessages();
        if (!email || !password || !adminToken) {
          if (signupError) signupError.textContent = 'Fill in all required fields.';
          return;
        }
        const base = ((window.BASE || window.DEFAULT_BACKEND || window.location.origin) || '').replace(/\/+$/, '');
        try {
          const res = await fetch(base + '/api/signup', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ email, password, adminToken }),
            credentials: 'include',
          });
          if (!res.ok) {
            const msg = res.status === 409 ? 'Email already registered.' : 'Signup failed.';
            if (signupError) signupError.textContent = msg;
            return;
          }
          const params = new URLSearchParams(window.location.search || '');
          const next = params.get('next') || '/';
          window.location.href = next;
        } catch (e) {
          if (signupError) signupError.textContent = 'Signup failed. Please retry.';
        }
      }

      async function doResetPassword() {
        const email = (document.getElementById('resetEmail')?.value || '').trim();
        const adminToken = (document.getElementById('resetAdminToken')?.value || '').trim();
        const newPassword = (document.getElementById('resetPassword')?.value || '').trim();
        const confirm = (document.getElementById('resetPasswordConfirm')?.value || '').trim();
        clearMessages();
        if (!email || !adminToken || !newPassword || !confirm) {
          if (resetError) resetError.textContent = 'Fill in all required fields.';
          return;
        }
        if (newPassword.length < 8) {
          if (resetError) resetError.textContent = 'Password must be at least 8 characters.';
          return;
        }
        if (newPassword !== confirm) {
          if (resetError) resetError.textContent = 'Passwords do not match.';
          return;
        }
        const base = ((window.BASE || window.DEFAULT_BACKEND || window.location.origin) || '').replace(/\/+$/, '');
        try {
          const res = await fetch(base + '/api/password/reset', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ email, adminToken, newPassword }),
            credentials: 'include',
          });
          if (!res.ok) {
            let msg = 'Reset failed.';
            if (res.status === 401) msg = 'Invalid admin token.';
            if (res.status === 404) msg = 'Email not found.';
            if (resetError) resetError.textContent = msg;
            return;
          }
          setView('login');
          if (loginNotice) {
            loginNotice.textContent = 'Password reset. Please log in.';
            loginNotice.classList.remove('hidden');
          }
        } catch (e) {
          if (resetError) resetError.textContent = 'Reset failed. Please retry.';
        }
      }

      showSignup?.addEventListener('click', () => setView('signup'));
      showLoginFromSignup?.addEventListener('click', () => setView('login'));
      showReset?.addEventListener('click', () => setView('reset'));
      showLoginFromReset?.addEventListener('click', () => setView('login'));
      googleLogin?.addEventListener('click', () => {
        const params = new URLSearchParams(window.location.search || '');
        const next = params.get('next') || '/';
        const base = ((window.BASE || window.DEFAULT_BACKEND || window.location.origin) || '').replace(/\/+$/, '');
        window.location.href = base + '/api/auth/google?next=' + encodeURIComponent(next);
      });
      loginForm?.addEventListener('submit', (e) => { e.preventDefault(); doLogin(); });
      signupForm?.addEventListener('submit', (e) => { e.preventDefault(); doSignup(); });
      resetForm?.addEventListener('submit', (e) => { e.preventDefault(); doResetPassword(); });
      loginBtn?.addEventListener('click', (e) => { e.preventDefault(); doLogin(); });
      signupBtn?.addEventListener('click', (e) => { e.preventDefault(); doSignup(); });
      resetBtn?.addEventListener('click', (e) => { e.preventDefault(); doResetPassword(); });

      const params = new URLSearchParams(window.location.search || '');
      const error = params.get('error');
      if (error && loginError) {
        loginError.textContent = 'Google login failed. Please try again.';
      }
      setView('login');
    });
  </script>
</body>

</html>
